- name: Ensure configuration
  template:
    src: env.j2
    dest: "{{ bitwardenrs_directory }}/.env"
    owner: bitwardenrs
    group: bitwardenrs
    mode: u=rw,go=
  notify: Restart bitwardenrs

- name: Copy encryption rsa key
  copy:
    content: "{{ bitwardenrs_encryption_key }}"
    dest: "{{ bitwardenrs_datadir }}/rsa_key.pem"
    owner: bitwardenrs
    group: bitwardenrs
    mode: u=rw,go=
    force: "{{ bitwardenrs_force_encryption_key }}"
  register: __bitwardenrs_copy_encryption_rsa_key
  when: bitwardenrs_encryption_key|length > 0

- name: Create DER privkey
  command:
    cmd: openssl rsa -in {{ bitwardenrs_datadir }}/rsa_key.pem -out {{ bitwardenrs_datadir }}/rsa_key.der -outform DER
  when: __bitwardenrs_copy_encryption_rsa_key.changed

- name: Create DER pubkey
  command:
    cmd: openssl rsa -in {{ bitwardenrs_datadir }}/rsa_key.pem -out {{ bitwardenrs_datadir }}/rsa_key.pub.der -outform DER -pubout
  when: __bitwardenrs_copy_encryption_rsa_key.changed

- name: Set permissions on keys in DER format
  file:
    path: "{{ bitwardenrs_datadir }}/{{ item }}"
    owner: bitwardenrs
    group: bitwardenrs
    mode: u=rw,go=
  loop:
    - rsa_key.der
    - rsa_key.pub.der
  when: bitwardenrs_encryption_key|length > 0

- name: Setup systemd service
  template:
    src: systemd.service.j2
    dest: /lib/systemd/system/bitwardenrs.service
  notify: Restart bitwardenrs
